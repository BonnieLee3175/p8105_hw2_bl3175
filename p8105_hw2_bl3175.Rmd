---
title: "p8105_hw2_bl3175"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)  
library(readxl)     
library(janitor)  
library(lubridate)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r problem1, echo=TRUE}
# 1) Import and clean pols data
pols <- read_csv("./data/pols-month.csv") |>
  separate(mon, into = c("year","month","day"), convert = TRUE) |>  # split YYYY-MM-DD
  mutate(
    month     = tolower(month.name[month]),   # number -> month name (lowercase)
    president = if_else(prez_gop == 1, "gop", "dem"),
    month_num = match(month, tolower(month.name))  # 1..12 for stable sorting
  ) |>
  select(year, month, month_num, president, starts_with("gov"), starts_with("sen"),
         -prez_dem, -prez_gop, -day) |>
  arrange(year, month_num) |>
  select(-month_num)

# 2) Import and clean snp data
snp <- read_csv("./data/snp.csv") |>
  separate(date, into = c("year","month","day"), convert = TRUE) |>
  mutate(
    month     = tolower(month.name[month]),
    month_num = match(month, tolower(month.name))
  ) |>
  select(year, month, month_num, close) |>
  arrange(year, month_num) |>
  select(-month_num)

# 3) Import and tidy unemployment data (wide -> long)
unemp <- read_csv("./data/unemployment.csv") |>
  pivot_longer(
    cols = -Year,
    names_to  = "month_abbr",
    values_to = "unemployment"
  ) |>
  mutate(
    month     = tolower(month.name[match(month_abbr, month.abb)]),
    month_num = match(month, tolower(month.name))
  ) |>
  rename(year = Year) |>   
  select(year, month, month_num, unemployment) |>
  arrange(year, month_num) |>
  select(-month_num)

# 4) Merge all datasets
p1_merged <- pols |>
  left_join(snp,  by = c("year","month")) |>
  left_join(unemp, by = c("year","month"))

# 5) Quick summary in output
dim(p1_merged)                         # dimensions
range(p1_merged$year, na.rm = TRUE)    # year range
names(p1_merged)                       # variable names
head(p1_merged, 5)                     # peek first rows
```

The merged dataset has `r nrow(p1_merged)` rows and `r ncol(p1_merged)` columns, covering years `r min(p1_merged$year, na.rm = TRUE)`â€“`r max(p1_merged$year, na.rm = TRUE)`. Key variables include the month label (month), the party of the sitting president (president), the S&P 500 closing level (close), and the unemployment rate (unemployment). Column names are: `r paste(names(p1_merged), collapse = ", ")`.

```{r problem2, echo=TRUE, message=FALSE, warning=FALSE}
# --- helpers to standardize column names across sheets -----------------
# ensure there is a 'sports' integer column
std_sports <- function(df) {
  if ("sports" %in% names(df)) {
    df |> dplyr::mutate(sports = as.integer(round(sports)))
  } else if ("sports_balls" %in% names(df)) {
    df |> dplyr::rename(sports = sports_balls) |>
      dplyr::mutate(sports = as.integer(round(sports)))
  } else {
    df |> dplyr::mutate(sports = NA_integer_)
  }
}

# ensure 'weight_tons' exists
std_weight <- function(df) {
  if ("weight_tons" %in% names(df)) df
  else if ("weight" %in% names(df)) dplyr::rename(df, weight_tons = weight)
  else df
}

# ensure 'cigarette_butts' exists
std_cigs <- function(df) {
  if ("cigarette_butts" %in% names(df)) df
  else if ("cigarette" %in% names(df)) dplyr::rename(df, cigarette_butts = cigarette)
  else df |> dplyr::mutate(cigarette_butts = NA_real_)
}

# read one sheet and clean
read_trash <- function(sheet_name, wheel_label) {
  readxl::read_excel("./data/202409 Trash Wheel Collection Data.xlsx",
                     sheet = sheet_name, skip = 1) |>
    janitor::clean_names() |>                  # snake_case names
    dplyr::filter(!is.na(dumpster)) |>         # drop non-data rows
    dplyr::mutate(year = as.integer(year)) |>  # <<< make 'year' consistent
    std_weight() |> std_cigs() |> std_sports() |>
    dplyr::mutate(wheel = wheel_label,
                  month = stringr::str_to_title(month))  # e.g., "June"
}

# read three wheels
mr   <- read_trash("Mr. Trash Wheel",         "Mr")
prof <- read_trash("Professor Trash Wheel",   "Professor")
gw   <- read_trash("Gwynnda Trash Wheel",     "Gwynnda")

# combine
trash <- dplyr::bind_rows(mr, prof, gw)

# summaries required by the prompt
prof_total_weight <- trash |>
  dplyr::filter(wheel == "Professor") |>
  dplyr::summarise(total_weight_tons = sum(weight_tons, na.rm = TRUE))

gw_cig_2022_06 <- trash |>
  dplyr::filter(wheel == "Gwynnda", year == 2022, month == "June") |>
  dplyr::summarise(total_cig_butts = sum(cigarette_butts, na.rm = TRUE))

# counts for inline R if needed
n_obs_trash <- nrow(trash)
vars_trash  <- names(trash)

# quick peek
head(trash, 5)
prof_total_weight
gw_cig_2022_06
```

The combined Trash Wheel dataset has `r nrow(trash)` rows, including variables such as dumpster, month, year, weight_tons, and cigarette_butts. For available data, Professor Trash Wheel collected `r round(dplyr::pull(prof_total_weight, total_weight_tons), 2)` tons in total. Gwynnda collected `r dplyr::pull(gw_cig_2022_06, total_cig_butts)` cigarette butts in June 2022.

```{r problem3, echo=TRUE, message=FALSE, warning=FALSE}
# --- Problem 3: NYC ZORI data ------------------------------------------

# clean ZIP metadata
zip_meta <- read_csv("./data/Zip Codes.csv", show_col_types = FALSE) |>
  clean_names() |>
  select(
    county = county,
    zip    = matches("^zip"),
    neighborhood = neighborhood
  ) |>
  mutate(
    county = str_trim(county),
    borough = case_match(
      county,
      "Bronx" ~ "Bronx",
      "Kings" ~ "Brooklyn",
      "New York" ~ "Manhattan",
      "Queens" ~ "Queens",
      "Richmond" ~ "Staten Island",
      .default = county
    ),
    zip = as.character(zip)
  ) |>
  select(borough, neighborhood, zip)

# clean Zillow ZORI
zori_raw <- read_csv("./data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv",
                     show_col_types = FALSE) |>
  clean_names()

meta_cols <- c("region_id","size_rank","region_name","region_type",
               "state_name","state","city","metro","county_name")

zori_tidy <- zori_raw |>
  filter(region_type == "zip", state_name == "NY") |>
  pivot_longer(
    cols = -all_of(meta_cols),
    names_to   = "ymd_str",
    values_to  = "zori"
  ) |>
  mutate(
    ymd_str = str_remove(ymd_str, "^x"),
    date    = ymd(str_replace_all(ymd_str, "_", "-"), quiet = TRUE),
    ym      = floor_date(date, "month"),
    zip     = as.character(region_name),
    borough = case_match(
      county_name,
      "Bronx County" ~ "Bronx",
      "Kings County" ~ "Brooklyn",
      "New York County" ~ "Manhattan",
      "Queens County" ~ "Queens",
      "Richmond County" ~ "Staten Island",
      .default = county_name
    )
  ) |>
  select(zip, borough, ym, zori)

# merge ZORI with metadata
zori_final <- zori_tidy |>
  left_join(select(zip_meta, zip, borough_meta = borough, neighborhood),
            by = "zip") |>
  mutate(borough = coalesce(borough, borough_meta)) |>
  select(zip, borough, neighborhood, ym, zori)

# summary numbers
n_obs_p3   <- nrow(zori_final)
n_zip_p3   <- n_distinct(zori_final$zip)
n_neigh_p3 <- n_distinct(na.omit(zori_final$neighborhood))

# ZIP codes missing in Zillow
zips_only_in_meta <- setdiff(zip_meta$zip, unique(zori_final$zip))

# changes from 2020 to 2021
zori_2020_01 <- zori_final |>
  filter(ym == ymd("2020-01-01")) |>
  select(zip, zori_2020_01 = zori)

zori_2021_01 <- zori_final |>
  filter(ym == ymd("2021-01-01")) |>
  select(zip, zori_2021_01 = zori)

drops_tbl <- zori_2020_01 |>
  inner_join(zori_2021_01, by = "zip") |>
  mutate(drop = zori_2021_01 - zori_2020_01) |>
  left_join(distinct(zori_final, zip, borough, neighborhood), by = "zip") |>
  arrange(drop) |>
  slice_head(n = 10) |>
  select(zip, borough, neighborhood, zori_2020_01, zori_2021_01, drop)
head(zori_final, 5)
tibble::tibble(zips_only_in_meta = head(zips_only_in_meta, 10))
drops_tbl
```

The tidy NYC ZORI dataset has `r nrow(zori_final)` rows, covering `r n_distinct(zori_final$zip)` unique ZIP codes and `r n_distinct(na.omit(zori_final$neighborhood))` unique neighborhoods. There are `r length(zips_only_in_meta)` ZIP codes present in the ZIP metadata but not in the Zillow dataset (e.g., `r paste(head(zips_only_in_meta, 3), collapse = ", ")`). Comparing January 2020 to January 2021, the largest drop occurs at ZIP `r dplyr::slice_head(drops_tbl, n = 1) |> dplyr::pull(zip)` in `r dplyr::slice_head(drops_tbl, n = 1) |> dplyr::pull(borough)`, with neighborhood `r dplyr::slice_head(drops_tbl, n = 1) |> dplyr::pull(neighborhood)`, changing from `r dplyr::slice_head(drops_tbl, n = 1) |> dplyr::pull(zori_2020_01)` to `r dplyr::slice_head(drops_tbl, n = 1) |> dplyr::pull(zori_2021_01)`, a difference of `r dplyr::slice_head(drops_tbl, n = 1) |> dplyr::pull(drop)`.