---
title: "p8105_hw2_bl3175"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)  
library(readxl)     
library(janitor)     
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r problem1, echo=TRUE}
# 1) Import and clean pols data
pols <- read_csv("./data/pols-month.csv") |>
  separate(mon, into = c("year","month","day"), convert = TRUE) |>  # split YYYY-MM-DD
  mutate(
    month     = tolower(month.name[month]),   # number -> month name (lowercase)
    president = if_else(prez_gop == 1, "gop", "dem"),
    month_num = match(month, tolower(month.name))  # 1..12 for stable sorting
  ) |>
  select(year, month, month_num, president, starts_with("gov"), starts_with("sen"),
         -prez_dem, -prez_gop, -day) |>
  arrange(year, month_num) |>
  select(-month_num)

# 2) Import and clean snp data
snp <- read_csv("./data/snp.csv") |>
  separate(date, into = c("year","month","day"), convert = TRUE) |>
  mutate(
    month     = tolower(month.name[month]),
    month_num = match(month, tolower(month.name))
  ) |>
  select(year, month, month_num, close) |>
  arrange(year, month_num) |>
  select(-month_num)

# 3) Import and tidy unemployment data (wide -> long)
unemp <- read_csv("./data/unemployment.csv") |>
  pivot_longer(
    cols = -Year,
    names_to  = "month_abbr",
    values_to = "unemployment"
  ) |>
  mutate(
    month     = tolower(month.name[match(month_abbr, month.abb)]),
    month_num = match(month, tolower(month.name))
  ) |>
  rename(year = Year) |>   
  select(year, month, month_num, unemployment) |>
  arrange(year, month_num) |>
  select(-month_num)

# 4) Merge all datasets
p1_merged <- pols |>
  left_join(snp,  by = c("year","month")) |>
  left_join(unemp, by = c("year","month"))

# 5) Quick summary in output
dim(p1_merged)                         # dimensions
range(p1_merged$year, na.rm = TRUE)    # year range
names(p1_merged)                       # variable names
head(p1_merged, 5)                     # peek first rows
```

```{r problem2, echo=TRUE, message=FALSE, warning=FALSE}
# --- helpers to standardize column names across sheets -----------------
# ensure there is a 'sports' integer column
std_sports <- function(df) {
  if ("sports" %in% names(df)) {
    df |> dplyr::mutate(sports = as.integer(round(sports)))
  } else if ("sports_balls" %in% names(df)) {
    df |> dplyr::rename(sports = sports_balls) |>
      dplyr::mutate(sports = as.integer(round(sports)))
  } else {
    df |> dplyr::mutate(sports = NA_integer_)
  }
}

# ensure 'weight_tons' exists
std_weight <- function(df) {
  if ("weight_tons" %in% names(df)) df
  else if ("weight" %in% names(df)) dplyr::rename(df, weight_tons = weight)
  else df
}

# ensure 'cigarette_butts' exists
std_cigs <- function(df) {
  if ("cigarette_butts" %in% names(df)) df
  else if ("cigarette" %in% names(df)) dplyr::rename(df, cigarette_butts = cigarette)
  else df |> dplyr::mutate(cigarette_butts = NA_real_)
}

# read one sheet and clean
read_trash <- function(sheet_name, wheel_label) {
  readxl::read_excel("./data/202409 Trash Wheel Collection Data.xlsx",
                     sheet = sheet_name, skip = 1) |>
    janitor::clean_names() |>                  # snake_case names
    dplyr::filter(!is.na(dumpster)) |>         # drop non-data rows
    dplyr::mutate(year = as.integer(year)) |>  # <<< make 'year' consistent
    std_weight() |> std_cigs() |> std_sports() |>
    dplyr::mutate(wheel = wheel_label,
                  month = stringr::str_to_title(month))  # e.g., "June"
}

# read three wheels
mr   <- read_trash("Mr. Trash Wheel",         "Mr")
prof <- read_trash("Professor Trash Wheel",   "Professor")
gw   <- read_trash("Gwynnda Trash Wheel",     "Gwynnda")

# combine
trash <- dplyr::bind_rows(mr, prof, gw)

# summaries required by the prompt
prof_total_weight <- trash |>
  dplyr::filter(wheel == "Professor") |>
  dplyr::summarise(total_weight_tons = sum(weight_tons, na.rm = TRUE))

gw_cig_2022_06 <- trash |>
  dplyr::filter(wheel == "Gwynnda", year == 2022, month == "June") |>
  dplyr::summarise(total_cig_butts = sum(cigarette_butts, na.rm = TRUE))

# counts for inline R if needed
n_obs_trash <- nrow(trash)
vars_trash  <- names(trash)

# quick peek
head(trash, 5)
prof_total_weight
gw_cig_2022_06
```
